<!-- {{ track.id }} -->
<div class="track
  {% if track.eligible %}
    eligible
  {% else %}
    ineligible
  {% endif %}
  {% if user.is_authenticated or track.eligible %}
    selectable
  {% else %}
    unselectable
  {% endif %}
  {% if track.is_new %}
    new
  {% endif %}
  {% if track.inudesu %}
    inudesu 
  {% endif %}
  "
  id="{{ track.id }}">
  {% if track.is_new %}
    <div class="stamp new">
      <a href="/recent/">
        New!
      </a>
    </div>
  {% endif %}
  <span class="report"><a href="{{ track.report_url }}">bad metadata?</a></span>
  <div class="metacontainer">
    <div class="metadata">
      <p class="artist"><a href="/artist/{{ track.artist|urlencode }}/">{{ track.artist }}</a></p>
      <p class="title">
      <span class="title"><a href="{{ track.rel_url }}">{{ track.derived_title }}</a></span>
      </p>

      <p class="metameta">
      {% if track.derived_role %}
        <span class="role">{{ track.derived_role }}</span>
        <span class="separator">|</span>
      {% endif %}

      {% if track.last_played %}
        <span class="last_played">played <a href="/show/{{ track.last_played_showtime|date:"d-m-Y" }}/">
          {% if track.weeks_since_play == 0 %}
            this week
          {% elif track.weeks_since_play == 1 %}
            last week
          {% else %}
            {{ track.weeks_since_play }} weeks ago
          {% endif %}
          </a>
        <span class="separator">|</span>
        </span>
      {% endif %}

      <span class="length">{{ track.length_str }}</span>

      </p>
      {% if user.is_authenticated %}
        <p class="peter">
          <a href="/played/{{ track.id }}/">now playing&hellip;</a> | <a href="/vote/{{ track.id }}/">add vote&hellip;</a>
          {% if track.ineligible and track.ineligible == 'blocked' %}
            | <a href="/unblock/{{ track.id }}/?from={{ path|urlencode }}">unblock</a>
          {% elif track.eligible %}
            | <a href="/block/{{ track.id }}/">block&hellip;</a>
          {% endif %}
        </p>
        <p class="peter">
          {% if track.hidden %}
            <a href="/unhide/{{ track.id }}/?from={{ path|urlencode }}">unhide</a>
          {% else %}
            <a href="/hide/{{ track.id }}/?from={{ path|urlencode }}">hide</a>
          {% endif %}
          |
          {% if not track.shortlist and not track.discard %}
            <a href="/shortlist/{{ track.id }}/?from={{ path|urlencode }}">shortlist</a> | <a href="/discard/{{ track.id }}/?from={{ path|urlencode }}">discard</a>
          {% elif track.shortlist %}
            <a href="/unshortlist_or_undiscard/{{ track.id }}/?from={{ path|urlencode }}">un-shortlist</a>
          {% elif track.discard %}
            <a href="/unshortlist_or_undiscard/{{ track.id }}/?from={{ path|urlencode }}">un-discard</a>
          {% endif %}
        </p>
      {% endif %}
      {% if user.is_authenticated and not track.eligible and track.undoable %}
        <p class="peter"><a href="/unplay/{{ track.id }}/">i didn't mean to play this</a></p>
      {% endif %}
      {% if track.ineligible and track.ineligible != 'played last week' and track.ineligible != 'played this week' %}
        <p class="refusal">{{ track.ineligible }}</p>
      {% endif %}
      </div>
    </div>
    <div class="votedata">
    {% if track.has_votes %}
      <div class="voters">
        <div class="votes">
        {% endif %}
        {% for vote in track.votes %}
          <a class="voter{% if vote.content %} commented{% endif %}" href="{{ vote.user_url }}">
            <img src="{{ vote.user_image }}" alt="{{ vote.screen_name }}">
            <div class="tweet_deets">
              <p class="full_name">{{ vote.name }}</p>
              <p class="meta">
                <span class="screen_name">@{{ vote.screen_name }}</span>
                {% if vote.content %}
                  | <span class="when">{{ vote.when }}</span>
                {% else %}
                  </p><p class="meta when"> {{ vote.when }}
                {% endif %}
              </p>
              {% if vote.content %}<p class="text">{{ vote.content|safe }}</p>{% endif %}
            </div> <!-- tweet deets -->
          </a>
        {% endfor %}
        {% for vote in track.manual_votes %}
          <a class="voter manual {{ vote.kind }}{% if vote.anonymous %} anonymous{% endif %}" href="{% if vote.kind == 'tweet' and not vote.anonymous %}http://twitter.com/{{ vote.name }}{% else %}#{% endif %}">
            <img src="{{ STATIC_URL}}i/{{ vote.kind }}.png" alt="{{ vote.kind }}">
            <div class="tweet_deets">
              {% if not vote.anonymous or user.is_authenticated %}
                <span class="screen_name">{% if vote.kind == 'tweet' %}@{% endif %}{{ vote.name }}{% if vote.anonymous %} (anonymous){% endif %}</span>{% if vote.message %}:
                <span class="text">{{ vote.message }}</span>
              {% endif %}
            {% else %}
              <span class="text">[anonymous request]</span>
            {% endif %}
          </div> <!-- tweet deets -->
        </a>
      {% endfor %}
      {% if track.has_votes %}
        </div> <!-- votes -->
      {% endif %}
      {% if not user.is_authenticated and track.eligible %}
        <div class="invitation {% if track.has_votes %}plusone{% else %}request{% endif %}"><a href="{{ track.vote_url }}">
            {% if track.has_votes %}
              +1
            {% else %}
              request this song
            {% endif %}
          </a>
        </div> <!-- invitation -->
        {% endif %}
      {% if track.has_votes %}
    </div> <!-- voters -->
  {% endif %}
  </div> <!-- votedata -->
</div> <!-- track -->
