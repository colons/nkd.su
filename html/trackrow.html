<!-- {{ track.id }} -->
<div class="track
  {% if track.eligible %}
    eligible
  {% else %}
    ineligible
  {% endif %}
  {% if user.is_authenticated or track.eligible %}
    selectable
  {% else %}
    unselectable
  {% endif %}
  "
  id="{{ track.id }}">
  <div class="metacontainer">
    <div class="metadata">
      <p class="artist"><a href="/artist/{{ track.artist|urlencode }}/">{{ track.artist }}</a></p>
      <p class="title">
      <span class="title">{{ track.derived_title }}</span>
      </p>


      {% if track.derived_role %}
        <p class="role">{{ track.derived_role }}</p>
      {% endif %}

      {% if track.last_played %}
        <p class="last_played">last played <a href="/show/{{ track.last_played|date:"d-m-Y" }}/">{{ track.last_played|date:"d-m-Y" }}</a>,
        {% if track.weeks_since_play == 0 %}
          this week
        {% elif track.weeks_since_play == 1 %}
          last week
        {% else %}
          {{ track.weeks_since_play }} weeks ago</p>
        {% endif %}
      {% endif %}
      {% if user.is_authenticated and track.eligible %}
      <p class="peter"><a href="/played/{{ track.id }}/">now playing&hellip;</a> | <a href="/vote/{{ track.id }}/">add vote&hellip;</a> | <a href="/block/{{ track.id }}/">block&hellip;</a></p>
      {% if not track.shortlist and not track.discard %}
      <p class="peter"><a href="/shortlist/{{ track.id }}/?from={{ path|urlencode }}">shortlist</a> | <a href="/discard/{{ track.id }}/?from={{ path|urlencode }}">discard</a></p>
      {% elif track.shortlist %}
      <p class="peter"><a href="/unshortlist_or_undiscard/{{ track.id }}/?from={{ path|urlencode }}">un-shortlist</a></p>
      {% elif track.discard %}
      <p class="peter"><a href="/unshortlist_or_undiscard/{{ track.id }}/?from={{ path|urlencode }}">un-discard</a></p>
      {% endif %}
      {% endif %}
      {% if user.is_authenticated and not track.eligible and track.undoable %}
        <p class="peter"><a href="/unplay/{{ track.id }}/">i didn't mean to play this</a></p>
      {% endif %}
      {% if track.ineligible and track.ineligible != 'played last week' and track.ineligible != 'played this week' %}
        <p class="refusal">{{ track.ineligible }}</p>
        {% if user.is_authenticated %}
          <p class="peter"><a href="/unblock/{{ track.id }}/?from={{ path|urlencode }}">unblock</a>
        {% endif %}
      {% endif %}
      </div>
    </div>
    <div class="votedata">
    <div class="voters">
      <!-- fuck it 
      {% if track.ineligible %}
        <div class="disabled">
          [disabled]
        </div>
      {% endif %} -->
      {% if votes %}
        <div class="votes">
      {% endif %}
      {% for vote in track.votes %}
        <a target="_blank" class="voter{% if vote.content %} commented{% endif %}" href="http://twitter.com/{{ vote.screen_name }}/status/{{ vote.tweet_id }}/">
            <img src="{{ vote.user_image }}" alt="{{ vote.screen_name }}">
              <div class="tweet_deets">
                <p class="full_name">{{ vote.name }}</p><p class="screen_name">@{{ vote.screen_name }}</p>
                {% if vote.content %}<p class="text">{{ vote.content|safe }}</p>{% endif %}
              </div>
          </a>
        {% endfor %}
        {% for vote in track.manual_votes %}
          <a class="voter manual {{ vote.kind }}{% if vote.anonymous %} anonymous{% endif %}" href="{% if vote.kind == 'tweet' and not vote.anonymous %}http://twitter.com/{{ vote.name }}{% else %}#{% endif %}">
            <img src="{{ STATIC_URL}}i/{{ vote.kind }}.png" alt="{{ vote.kind }}">
              <div class="tweet_deets">
              {% if not vote.anonymous or user.is_authenticated %}
                <span class="screen_name">{% if vote.kind == 'tweet' %}@{% endif %}{{ vote.name }}{% if vote.anonymous %} (anonymous){% endif %}</span>{% if vote.message %}:
                <span class="text">{{ vote.message }}</span>
                {% endif %}
              {% else %}
                <span class="text">[anonymous request]</span>
              {% endif %}
              </div>
        </a>
      {% endfor %}
      {% if votes %}
        </div>
      {% endif %}
        {% if not user.is_authenticated and track.eligible %}
          <div{% if track.votes %} class="plusone"{% endif %}><a href="{{ track.vote_url }}">
            {% if track.votes or track.manual_votes %}
              +1
            {% else %}
              request this track
            {% endif %}
          </a></div>
        {% endif %}
    </div> <!-- voters -->
    </div> <!-- votedata -->
  <div class="endof"></div>
</div>
